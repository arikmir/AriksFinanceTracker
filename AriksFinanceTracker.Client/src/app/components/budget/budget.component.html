<div class="budget-container">
  <mat-toolbar color="primary">
    <h1>Budget Dashboard</h1>
    <span class="spacer"></span>
    <button mat-icon-button (click)="refreshData()" matTooltip="Refresh Data">
      <mat-icon>refresh</mat-icon>
    </button>
  </mat-toolbar>

  <div class="content" *ngIf="!isLoading">
    <!-- Error Message -->
    <mat-card *ngIf="errorMessage" class="error-card">
      <mat-card-content>
        <div class="error-content">
          <mat-icon color="warn">error</mat-icon>
          <span>{{ errorMessage }}</span>
          <button mat-button (click)="refreshData()">Try Again</button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Success Content -->
    <div *ngIf="!errorMessage && budgetStatus" class="dashboard-grid">
      <!-- Overview Card -->
      <mat-card class="overview-card">
        <mat-card-content>
          <div class="overview-header">
            <div>
              <h2>{{ budgetStatus.currentPeriod }}</h2>
              <p class="period-desc">{{ budgetStatus.periodDescription }}</p>
            </div>
            <button mat-icon-button [matMenuTriggerFor]="menu" class="menu-trigger">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="viewFinancialHealth()">
                <mat-icon>insights</mat-icon>
                <span>Financial Health Score</span>
              </button>
              <button mat-menu-item (click)="viewAchievements()">
                <mat-icon>emoji_events</mat-icon>
                <span>Achievements</span>
              </button>
            </mat-menu>
          </div>

          <div class="metrics-grid">
            <div class="metric">
              <span class="metric-label">Income</span>
              <span class="metric-value income">{{ formatCurrency(budgetStatus.monthlyIncome) }}</span>
            </div>
            <div class="metric">
              <span class="metric-label">Spent</span>
              <span class="metric-value spent">{{ formatCurrency(budgetStatus.totalSpent) }}</span>
            </div>
            <div class="metric">
              <span class="metric-label">Saved</span>
              <span class="metric-value saved">{{ formatCurrency(budgetStatus.actualSavings) }}</span>
              <span class="metric-subtext">{{ formatPercentage(budgetStatus.savingsRate) }} rate</span>
            </div>
          </div>

          <div class="savings-progress">
            <div class="progress-header">
              <span>Savings Goal</span>
              <span>{{ formatCurrency(budgetStatus.actualSavings) }} / {{ formatCurrency(budgetStatus.savingsTarget) }}</span>
            </div>
            <mat-progress-bar 
              mode="determinate" 
              [value]="(budgetStatus.actualSavings / budgetStatus.savingsTarget) * 100"
              [color]="budgetStatus.savingsRate >= 20 ? 'primary' : 'accent'">
            </mat-progress-bar>
          </div>

          <div class="motivation-message" *ngIf="budgetStatus.savingsRate >= 15">
            <mat-icon>tips_and_updates</mat-icon>
            <span>{{ getMotivationalMessage() }}</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Category Budgets -->
      <div class="categories-section">
        <div class="section-header">
          <h3>Category Budgets</h3>
          <span class="days-left">{{ budgetStatus.daysLeftInMonth }} days left</span>
          <span class="section-actions">
            <button mat-stroked-button color="primary" (click)="openCreateCategoryDialog()">
              <mat-icon>add</mat-icon>
              Add Category
            </button>
          </span>
        </div>

        <div class="categories-grid">
          <mat-card *ngFor="let category of budgetStatus.categoryBudgets" 
                   class="category-card"
                   [class.warning]="category.percentageUsed >= 80"
                   [class.exceeded]="category.percentageUsed >= 100">
            <mat-card-content>
              <div class="category-header">
                <div class="category-info">
                  <mat-icon>{{ category.icon || getCategoryIcon(category.categoryName) }}</mat-icon>
                  <span class="category-name">{{ category.categoryName }}</span>
                  <mat-chip *ngIf="category.isEssential" class="essential-chip">Essential</mat-chip>
                </div>
                <button mat-icon-button 
                        (click)="editBudgetLimit(category)" 
                        class="edit-button"
                        matTooltip="Edit budget limit">
                  <mat-icon>edit</mat-icon>
                </button>
              </div>

              <div class="budget-amounts">
                <div class="amount-row">
                  <span class="spent">{{ formatCurrency(category.spent) }}</span>
                  <span class="limit">/ {{ formatCurrency(category.limit) }}</span>
                </div>
                <span class="percentage">{{ formatPercentage(category.percentageUsed) }}</span>
              </div>

              <mat-progress-bar 
                mode="determinate" 
                [value]="Math.min(100, category.percentageUsed)"
                [color]="getProgressColor(category.percentageUsed)">
              </mat-progress-bar>

              <div class="category-footer">
                <span class="remaining" [class.negative]="category.remaining < 0">
                  {{ category.remaining >= 0 ? 'Remaining' : 'Over' }}: {{ formatCurrency(Math.abs(category.remaining)) }}
                </span>
                <mat-chip class="status-chip" [class]="'status-' + category.statusColor">
                  {{ category.status }}
                </mat-chip>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Achievements Section (Dynamic) -->
      <mat-card class="achievements-card" *ngIf="achievements && achievements.length > 0">
        <mat-card-content>
          <div class="achievements-header">
            <mat-icon>celebration</mat-icon>
            <h3>{{ achievementMessage }}</h3>
          </div>
          <div class="achievements-list">
            <mat-chip *ngFor="let achievement of achievements" class="achievement-chip">
              <mat-icon>star</mat-icon>
              {{ achievement }}
            </mat-chip>
          </div>
          <button mat-button (click)="dismissAchievements()" class="dismiss-button">
            Dismiss
          </button>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner></mat-spinner>
    <p>Loading your budget...</p>
  </div>
</div>

<!-- Budget Edit Dialog Template -->
<ng-template #categoryCreateDialog>
  <h2 mat-dialog-title>Add Budget Category</h2>
  <mat-dialog-content>
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Category Name</mat-label>
      <input matInput [(ngModel)]="newCategoryName" placeholder="e.g. Subscriptions">
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Monthly Limit</mat-label>
      <input matInput type="number" min="0" step="10" [(ngModel)]="newCategoryLimit">
      <span matPrefix>$</span>
    </mat-form-field>

    <mat-checkbox [(ngModel)]="newCategoryIsEssential">
      Treat this as an essential expense
    </mat-checkbox>
  </mat-dialog-content>
  <mat-dialog-actions>
    <button mat-button mat-dialog-close [disabled]="isSavingNewCategory">Cancel</button>
    <button mat-raised-button color="primary" (click)="saveNewCategory()" [disabled]="isSavingNewCategory">
      <mat-icon>{{ isSavingNewCategory ? 'hourglass_top' : 'save' }}</mat-icon>
      {{ isSavingNewCategory ? 'Saving...' : 'Create Category' }}
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- Budget Edit Dialog Template -->
<ng-template #budgetEditDialog>
  <h2 mat-dialog-title>Edit Budget Limit</h2>
  <mat-dialog-content>
    <p>Adjust the monthly budget limit for {{ editingCategory?.categoryName }}</p>
    <mat-form-field appearance="outline">
      <mat-label>Monthly Limit</mat-label>
      <input matInput type="number" [(ngModel)]="newBudgetLimit" min="0" step="10">
      <span matPrefix>$</span>
    </mat-form-field>
  </mat-dialog-content>
  <mat-dialog-actions>
    <button mat-button mat-dialog-close>Cancel</button>
    <button mat-raised-button color="primary" (click)="saveBudgetLimit()">Save</button>
  </mat-dialog-actions>
</ng-template>

<!-- Financial Health Dialog -->
<ng-template #healthDialog>
  <h2 mat-dialog-title>Financial Health Score</h2>
  <mat-dialog-content *ngIf="financialHealth">
    <div class="health-score">
      <div class="score-circle">
        <span class="score">{{ financialHealth.score.toFixed(0) }}</span>
        <span class="score-label">/ 100</span>
      </div>
      <h3 class="grade" [class]="getHealthGradeColor(financialHealth.grade)">
        {{ financialHealth.grade }}
      </h3>
    </div>
    <p class="health-message">{{ financialHealth.message }}</p>
    <div class="recommendations" *ngIf="financialHealth.recommendations.length > 0">
      <h4>Recommendations:</h4>
      <ul>
        <li *ngFor="let rec of financialHealth.recommendations">{{ rec }}</li>
      </ul>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions>
    <button mat-button mat-dialog-close>Close</button>
  </mat-dialog-actions>
</ng-template>
