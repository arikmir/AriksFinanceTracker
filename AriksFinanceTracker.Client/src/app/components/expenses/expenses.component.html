<div class="expenses-container">
  <mat-toolbar color="primary" class="mat-elevation-z4">
    <mat-icon class="header-icon">receipt</mat-icon>
    <h1 class="mat-h1">Sophisticated Expense Tracker</h1>
    <span class="spacer"></span>
    <button mat-fab color="accent" class="add-fab" (click)="showAddForm = !showAddForm">
      <mat-icon>{{showAddForm ? 'close' : 'add'}}</mat-icon>
    </button>
  </mat-toolbar>
  
  <div class="content">
    <!-- Real-time Analytics -->
    <div class="analytics-grid">
      <mat-card class="stat-card today mat-elevation-z4">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon class="stat-icon">today</mat-icon>
            <h3>Today's Expenses</h3>
          </div>
          <div class="amount">${{getTodayTotal() | number:'1.2-2'}}</div>
          <div class="stat-meta">{{getTodayTransactionCount()}} transactions</div>
        </mat-card-content>
      </mat-card>
      
      <mat-card class="stat-card week mat-elevation-z4" *ngIf="weeklyAnalytics">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon class="stat-icon">date_range</mat-icon>
            <h3>This Week</h3>
          </div>
          <div class="amount">${{weeklyAnalytics.totalAmount | number:'1.2-2'}}</div>
          <div class="stat-meta">{{weeklyAnalytics.transactionCount}} transactions | Avg: ${{weeklyAnalytics.averageAmount | number:'1.2-2'}}</div>
        </mat-card-content>
      </mat-card>
      
      <mat-card class="stat-card month mat-elevation-z4" *ngIf="monthlyAnalytics">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon class="stat-icon">calendar_month</mat-icon>
            <h3>This Month</h3>
          </div>
          <div class="amount">${{monthlyAnalytics.totalAmount | number:'1.2-2'}}</div>
          <div class="stat-meta">{{monthlyAnalytics.transactionCount}} transactions | Avg: ${{monthlyAnalytics.averageAmount | number:'1.2-2'}}</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card categories mat-elevation-z4">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon class="stat-icon">donut_large</mat-icon>
            <h3>Top Category</h3>
          </div>
          <div class="top-category" *ngIf="categorySummary.length > 0">
            <mat-icon>{{getCategoryIcon(categorySummary[0].category)}}</mat-icon>
            <span>{{getCategoryLabel(categorySummary[0].category)}}</span>
            <div class="category-amount">${{categorySummary[0].totalAmount | number:'1.2-2'}}</div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Add/Edit Expense Form -->
    <mat-card class="expense-form-card mat-elevation-z6" *ngIf="showAddForm">
      <mat-card-header>
        <mat-card-title>{{editingExpense ? 'Edit' : 'Add New'}} Expense</mat-card-title>
        <mat-card-subtitle>Track your spending with detailed categorization</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="expenseForm" (ngSubmit)="onSubmit()" class="expense-form">
          <div class="form-row">
            <mat-form-field appearance="outline" class="amount-field">
              <mat-label>Amount</mat-label>
              <input matInput type="number" step="0.01" formControlName="amount" placeholder="0.00">
              <span matPrefix>$&nbsp;</span>
              <mat-error *ngIf="expenseForm.get('amount')?.hasError('required')">Amount is required</mat-error>
              <mat-error *ngIf="expenseForm.get('amount')?.hasError('min')">Amount must be greater than 0</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Date</mat-label>
              <input matInput [matDatepicker]="datePicker" formControlName="date">
              <mat-datepicker-toggle matSuffix [for]="datePicker"></mat-datepicker-toggle>
              <mat-datepicker #datePicker></mat-datepicker>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="category-field">
              <mat-label>Category</mat-label>
              <mat-select formControlName="category">
                <mat-option *ngFor="let category of categories" [value]="category">
                  <mat-icon>{{getCategoryIcon(category)}}</mat-icon>
                  {{getCategoryLabel(category)}}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Payment Method</mat-label>
              <mat-select formControlName="paymentMethod">
                <mat-option *ngFor="let method of paymentMethods" [value]="method">
                  {{method}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <input matInput formControlName="description" placeholder="What was this expense for?">
            <mat-error *ngIf="expenseForm.get('description')?.hasError('required')">Description is required</mat-error>
            <mat-error *ngIf="expenseForm.get('description')?.hasError('minlength')">Description must be at least 3 characters</mat-error>
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Location</mat-label>
              <input matInput formControlName="location" placeholder="Where did you spend this?">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Tags</mat-label>
              <input matInput formControlName="tags" placeholder="work, business, personal">
            </mat-form-field>
          </div>

          <mat-checkbox formControlName="isRecurring" class="recurring-checkbox">
            This is a recurring expense
          </mat-checkbox>

          <!-- Budget Guidance Section -->
          <div class="budget-guidance" *ngIf="showBudgetGuidance && spendingCheck">
            <mat-card class="guidance-card" [class]="'guidance-' + getAlertLevelColor(spendingCheck.alertLevel)">
              <mat-card-content>
                <div class="guidance-header">
                  <mat-icon [color]="getAlertLevelColor(spendingCheck.alertLevel)">
                    {{ getAlertLevelIcon(spendingCheck.alertLevel) }}
                  </mat-icon>
                  <h4>Budget Guidance</h4>
                </div>
                
                <div class="guidance-content">
                  <p class="guidance-message">{{ spendingCheck.message }}</p>
                  <p class="encouragement">{{ spendingCheck.encouragement }}</p>
                  
                  <div class="budget-details" *ngIf="getCategoryBudgetInfo(expenseForm.get('category')?.value) as categoryBudget">
                    <div class="budget-summary">
                      <div class="budget-row">
                        <span>Category Budget:</span>
                        <span class="budget-amount">{{ formatCurrency(categoryBudget.limit) }}</span>
                      </div>
                      <div class="budget-row">
                        <span>Currently Spent:</span>
                        <span class="spent-amount">{{ formatCurrency(categoryBudget.spent) }}</span>
                      </div>
                      <div class="budget-row">
                        <span>After This Expense:</span>
                        <span class="new-total">{{ formatCurrency(categoryBudget.spent + (expenseForm.get('amount')?.value || 0)) }}</span>
                      </div>
                      <div class="budget-row">
                        <span>Remaining Budget:</span>
                        <span class="remaining" [class]="spendingCheck.remainingBudget < 0 ? 'negative' : 'positive'">
                          {{ formatCurrency(spendingCheck.remainingBudget) }}
                        </span>
                      </div>
                    </div>
                    
                    <div class="budget-progress">
                      <div class="progress-label">
                        <span>Budget Usage: {{ formatPercentage(spendingCheck.newPercentageUsed) }}</span>
                      </div>
                      <mat-progress-bar 
                        mode="determinate" 
                        [value]="Math.min(100, spendingCheck.newPercentageUsed)"
                        [color]="getAlertLevelColor(spendingCheck.alertLevel)">
                      </mat-progress-bar>
                    </div>

                    <div class="daily-guidance" *ngIf="categoryBudget.dailyRecommendation > 0">
                      <mat-icon>schedule</mat-icon>
                      <span>Recommended daily spending: {{ formatCurrency(categoryBudget.dailyRecommendation) }}</span>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Current Category Budget Overview -->
          <div class="current-category-budget" *ngIf="expenseForm.get('category')?.value !== null && getCategoryBudgetInfo(expenseForm.get('category')?.value) as categoryBudget">
            <mat-card class="category-overview">
              <mat-card-content>
                <div class="category-header">
                  <mat-icon>{{ getCategoryIcon(expenseForm.get('category')?.value) }}</mat-icon>
                  <h4>{{ getCategoryLabel(expenseForm.get('category')?.value) }} Budget</h4>
                  <span class="status-badge" [class]="'status-' + categoryBudget.statusColor">
                    {{ categoryBudget.status }}
                  </span>
                </div>
                
                <div class="category-stats">
                  <div class="stat">
                    <span class="label">Spent</span>
                    <span class="value">{{ formatCurrency(categoryBudget.spent) }}</span>
                  </div>
                  <div class="stat">
                    <span class="label">Budget</span>
                    <span class="value">{{ formatCurrency(categoryBudget.limit) }}</span>
                  </div>
                  <div class="stat">
                    <span class="label">Remaining</span>
                    <span class="value" [class]="categoryBudget.remaining < 0 ? 'negative' : 'positive'">
                      {{ formatCurrency(categoryBudget.remaining) }}
                    </span>
                  </div>
                </div>
                
                <div class="category-progress">
                  <mat-progress-bar 
                    mode="determinate" 
                    [value]="categoryBudget.percentageUsed"
                    [color]="categoryBudget.statusColor === 'green' ? 'primary' : categoryBudget.statusColor === 'yellow' ? 'accent' : 'warn'">
                  </mat-progress-bar>
                  <span class="progress-text">{{ formatPercentage(categoryBudget.percentageUsed) }} used</span>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="form-actions">
            <button mat-button type="button" (click)="resetForm()">
              Cancel
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="expenseForm.invalid">
              <mat-icon>{{editingExpense ? 'save' : 'add'}}</mat-icon>
              {{editingExpense ? 'Update' : 'Add'}} Expense
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Advanced Filters -->
    <mat-card class="filter-card mat-elevation-z2">
      <mat-card-content>
        <div class="filter-header">
          <mat-icon>filter_list</mat-icon>
          <h3>Filter & Search</h3>
        </div>
        <div class="filter-controls">
          <mat-form-field appearance="outline">
            <mat-label>Category</mat-label>
            <mat-select [(value)]="filterCategory">
              <mat-option value="all">All Categories</mat-option>
              <mat-option *ngFor="let category of categories" [value]="category">
                <mat-icon>{{getCategoryIcon(category)}}</mat-icon>
                {{getCategoryLabel(category)}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Start Date</mat-label>
            <input matInput [matDatepicker]="startDatePicker" [(ngModel)]="startDate">
            <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #startDatePicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>End Date</mat-label>
            <input matInput [matDatepicker]="endDatePicker" [(ngModel)]="endDate">
            <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #endDatePicker></mat-datepicker>
          </mat-form-field>
          
          <button mat-raised-button color="primary" (click)="loadData()">
            <mat-icon>refresh</mat-icon>
            Refresh
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Category Summary -->
    <mat-card class="category-summary-card mat-elevation-z4" *ngIf="categorySummary.length > 0">
      <mat-card-header>
        <mat-card-title>Category Breakdown</mat-card-title>
        <mat-card-subtitle>Spending by category this month</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="category-list">
          <div class="category-item" *ngFor="let item of categorySummary">
            <div class="category-info">
              <mat-icon class="category-icon">{{getCategoryIcon(item.category)}}</mat-icon>
              <div class="category-details">
                <span class="category-name">{{item.categoryName}}</span>
                <span class="transaction-count">{{item.transactionCount}} transactions</span>
              </div>
            </div>
            <div class="category-amount">
              <span class="amount">${{item.totalAmount | number:'1.2-2'}}</span>
              <span class="percentage">{{item.percentage | number:'1.1-1'}}%</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Expense List -->
    <mat-card class="expense-list-card mat-elevation-z4">
      <mat-card-header>
        <mat-card-title>Recent Expenses</mat-card-title>
        <mat-card-subtitle>{{getFilteredExpenses().length}} expenses found</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="expense-list" *ngIf="getFilteredExpenses().length > 0; else noExpenses">
          <div class="expense-item" *ngFor="let expense of getFilteredExpenses()">
            <div class="expense-icon">
              <mat-icon>{{getCategoryIcon(expense.category)}}</mat-icon>
            </div>
            <div class="expense-details">
              <div class="expense-description">{{expense.description}}</div>
              <div class="expense-meta">
                <span class="category">{{getCategoryLabel(expense.category)}}</span>
                <span class="date">{{expense.date | date:'MMM d, y'}}</span>
                <span class="payment-method" *ngIf="expense.paymentMethod">{{expense.paymentMethod}}</span>
                <span class="location" *ngIf="expense.location">📍 {{expense.location}}</span>
              </div>
              <div class="expense-tags" *ngIf="expense.tags">
                <div class="tags-container">
                  <span *ngFor="let tag of expense.tags.split(',')" class="expense-tag">
                    {{tag.trim()}}
                  </span>
                </div>
              </div>
            </div>
            <div class="expense-amount">
              <span class="amount">${{expense.amount | number:'1.2-2'}}</span>
              <div class="expense-actions">
                <button mat-icon-button (click)="editExpense(expense)" matTooltip="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteExpense(expense)" matTooltip="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <ng-template #noExpenses>
          <div class="no-expenses">
            <mat-icon class="no-data-icon">receipt_long</mat-icon>
            <h3>No expenses found</h3>
            <p>Start tracking your expenses by clicking the + button above</p>
          </div>
        </ng-template>
      </mat-card-content>
    </mat-card>
  </div>
</div>
